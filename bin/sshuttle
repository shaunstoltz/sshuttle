#!/bin/sh
set -eu

SSH_KEY="${SSH_KEY:-"${HOME}/.ssh/id_rsa"}"

ADDITIONAL_VOLUME=""
if [ -f "${SSH_KEY}" ] ; then
    ADDITIONAL_VOLUME="--volume ${SSH_KEY}:/root/.ssh/id_rsa:ro"
fi

docker run \
    --cap-add NET_ADMIN \
    --interactive="$([ -t 0 ] && echo "true" || echo "false")" \
    --net host \
    --rm \
    --tty="$([ -t 0 ] && echo "true" || echo "false")" \
    --volume /etc/localtime:/etc/localtime:ro \
    --volume /etc/timezone:/etc/timezone:ro \
    ${ADDITIONAL_VOLUME} \
    "${IMAGE:-timonier/sshuttle}:${TAG:-latest}" sshuttle "$@"
